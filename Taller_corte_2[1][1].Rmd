---
title: "Taller  Datos de Colisiones"
author: "kevin, Gabriel y Brandon"
#date: "`r Sys.Date()`"
output:
  html_document:
    css: rany_style.css
    #theme: journal
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,
                      collapse = F,
                      fig.align='center',
                      warning=F,
                      message=F,
                      fig.height=6,
                      fig.width=7.5,
                      tidy = F,
                      comment = "",
                      prompt = F,
                      highlight=T)
library(DT)


```



```{r, echo=FALSE}
#install.packages("readr")
#install.packages("ggplot")
#install.packages("DT")
library(readr)
library(ggplot2)
library(tidyverse)
library(dplyr)
data_collisions <- read_csv("C:/Users/brand/OneDrive/Escritorio/UNIVERSIDAD/ESTEXPLOTARIA/combined_collisions_v3.csv")

```

```{r, echo=FALSE}

#str(data_collisions)
#table(data_collisions)

summary(data_collisions$Number_of_Casualties)


```

```{r, echo=FALSE}

summary(data_collisions$Speed_limit)

```

```{r, echo=FALSE}

summary(data_collisions$Accident_Severity)

```

```{r, echo=FALSE}

table(data_collisions$Accident_Severity)

```

## El número de accidentes leves es de 1664, mientras la accidentalidad moderada fue de 41911, y los accidentes de mayor gravedad fueron de 207388.

```{r, echo=FALSE}

summary(data_collisions$Accident_Severity)

```



## Velocidad por numero de accidentes

```{r, echo=FALSE}

grupo1<-data_collisions$Accident_Severity == 1
boxplot(grupo1)


```

```{r}

boxplot(
  x = data_collisions$Number_of_Casualties, 
  y = data_collisions$Speed_limit)

```

## Velocidad por numero de accidentes

```{r}

grupo1<-data_collisions$Accident_Severity == 1
boxplot(grupo1)


```

```{r}

severity1 <- data_collisions$Accident_Severity
table(severity1)

grupo1 <- filter(data_collisions, Accident_Severity==1)

```
```{r}


severity1 <- data_collisions$Accident_Severity
table(severity1)

grupo1 <- filter(data_collisions, Accident_Severity==1)

```


```{r, echo=FALSE}
ggplot(data_collisions, aes(x = as.factor(Accident_Severity), y = Number_of_Casualties,  fill = as.factor(Accident_Severity))) +
  geom_boxplot() + labs(x = "Severidad del Accidente", y = "Número de Víctimas",
       title = "Boxplot de Número de Víctimas según Severidad del Accidente")

```

```{r}
faltantes <- data.frame(
  Variable = c("time", "speed_limit"),
  Faltantes = c(sum(is.na(data_collisions$Time)),
                sum(is.na(data_collisions$Speed_limit)))
)
```

```{r}
punto31 <- intersect(c("Time", "Speed_limit"), names(data_collisions))
```


```{r}
faltantes_tabla <- data.frame(
  Variable = punto31,
  Faltantes_Absolutos = sapply(data_collisions[punto31], function(x) sum(is.na(x))),
  Porcentaje_Faltantes = sapply(data_collisions[punto31], function(x) mean(is.na(x)) * 100)
)
```

```{r}
faltantes_tabla
```

## ESTRATEGIA PARA MANEJAR LOS NAs
  1. Saber en donde estan y cuantos son 
  2. Verificar si es un error de la base de datos 
  3. limpiar los NAs 
     - mientras los NAs no superen el 5% se pueden eliminar
     - crear la categoria NAs si supera el 5%
     
```{r}

Q1 <- quantile(data_collisions$Number_of_Casualties, 0.25, na.rm = TRUE)
Q3 <- quantile(data_collisions$Number_of_Casualties, 0.75, na.rm = TRUE)
IQR_value <- IQR(data_collisions$Number_of_Casualties, na.rm = TRUE)
limite_inferior <- Q1 - 1.5 * IQR_value
limite_superior <- Q3 + 1.5 * IQR_value
cat("Límite inferior:", limite_inferior, "\n")
cat("Límite superior:", limite_superior, "\n")
```
```{r}
fuera_limites <- sum(data_collisions$Number_of_Casualties < 1 |
                     data_collisions$Number_of_Casualties > 1, 
                     na.rm = TRUE)


cat("Accidentes fuera de los límites (IQR):", fuera_limites, "\n")

```
```{r}
total <- nrow(data_collisions)
porcentaje_fuera <- (fuera_limites / total) * 100

cat("Porcentaje fuera de los límites:", round(porcentaje_fuera, 3), "%\n")

```
## Si tiene sentido eliminar los datos que estan fuera de los limites ya que no son significativos en la base de datos 

```{r}

library(dplyr)
# 2. Agrupar por Urban_or_Rural_Area y calcular estadísticas descriptivas
comparacion_urbano_rural <- data_collisions %>%
  group_by(Urban_or_Rural_Area) %>%
  summarise(
    Total_Accidentes = n(),
    Promedio_Victimas = mean(Number_of_Casualties, na.rm = TRUE),
    Maximo_Victimas = max(Number_of_Casualties, na.rm = TRUE),
    Minimo_Victimas = min(Number_of_Casualties, na.rm = TRUE)
  )

# 3. Mostrar resultados
comparacion_urbano_rural


```

```{r}
# Asignar etiquetas correctas
data_collisions$Urban_or_Rural_Area <- factor(data_collisions$Urban_or_Rural_Area,
                                              levels = c(1, 2, 3),
                                              labels = c("Urbana", "Rural", "Desconocida"))

# Cargar librería dplyr
library(dplyr)

# Calcular mediana de Speed_limit y total de accidentes por grupo
resumen_zonas <- data_collisions %>%
  group_by(Urban_or_Rural_Area) %>%
  summarise(
    mediana_Speed_limit = median(Speed_limit, na.rm = TRUE),
    total_accidentes = n()
  )

# Mostrar resultados
print(resumen_zonas)

```

```{r}
unique(data_collisions$Urban_or_Rural_Area)


```

```{r}
# Cargar librería para manejo de fechas
library(dplyr)

# Convertir 'Date' a formato de fecha (ajusta el formato si es necesario)
data_collisions <- data_collisions %>%
  mutate(
    Date = as.Date(Date, format = "%Y-%m-%d"),  # formato típico: 2020-05-17
    Accident_Year = year(Date)                  # extrae el año
  )

# Verificar los primeros registros
head(data_collisions[, c("Date", "Accident_Year")])


```
```{r}
library(dplyr)

# Agrupar por año y calcular totales
resumen <- data_collisions %>%
  group_by("Accident_Year") %>%
  summarise(
    total_heridos = sum(Number_of_Casualties, na.rm = TRUE),
    total_accidentes = n()
  )

# Mostrar resultado
print(resumen)


```

```{r}
# Si aún no tienes la tabla resumen, créala primero
library(dplyr)

resumen_anual <- data_collisions %>%
  group_by("Accident_Year") %>%
  summarise(
    total_heridos = sum(Number_of_Casualties, na.rm = TRUE)
  )

# Cargar ggplot2 para graficar
library(ggplot2)

# Crear gráfico de líneas
ggplot(resumen_anual, aes(x = "Accident_Year", y = total_heridos)) +
  geom_line(color = "red", size = 1.2) +
  geom_point(color = "darkred", size = 2) +
  labs(title = "Tendencia anual del número total de heridos",
       x = "Año del accidente",
       y = "Total de heridos") +
  theme_minimal()


```

```{r}
# Cargar la librería ggplot2
library(ggplot2)

# Crear el gráfico de dispersión
ggplot(data_collisions, aes(x = Longitude, y = Latitude)) +
  geom_point(alpha = 0.4, color = "blue") +
  labs(title = "Ubicación geográfica de los accidentes",
       x = "Longitud",
       y = "Latitud") +
  theme_minimal()



```
```{r}
ggplot(data_collisions, aes(x = Longitude, y = Latitude)) +
  geom_bin2d() +
  scale_fill_continuous(type = "viridis") +
  labs(title = "Densidad de accidentes por ubicación",
       x = "Longitud", y = "Latitud") +
  theme_minimal()



```

```{r}
library(ggplot2)
library(dplyr)

# Filtrar datos con coordenadas válidas
data_filtrada <- data_collisions %>%
  filter(!is.na(Longitude), !is.na(Latitude))

# (Opcional) Etiquetas descriptivas de gravedad
data_filtrada$Accident_Severity <- factor(data_filtrada$Accident_Severity,
                                          levels = c(1, 2, 3),
                                          labels = c("Fatal", "Grave", "Leve"))

# Crear gráfico con proporción geográfica fija
ggplot(data_filtrada, aes(x = Longitude, y = Latitude, color = Accident_Severity)) +
  geom_point(alpha = 0.6) +
  coord_fixed() +
  labs(title = "Ubicación de accidentes según gravedad",
       x = "Longitud",
       y = "Latitud",
       color = "Gravedad del accidente") +
  theme_minimal()

```
